[root@nosql salt]# salt -G 'roles:nginx' state.sls nginx_conf
ytadmin02.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.200235
    Duration: 41.054 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -38,7 +38,7 @@
                       sendfile        on;
                       tcp_nopush      on;
                       tcp_nodelay on;
                  -    keepalive_timeout  100;
                  +    keepalive_timeout  30;
                       server_tokens off;
                   
                       fastcgi_connect_timeout 300;
                  @@ -61,11 +61,11 @@
                       x-httpd-php image/jpeg image/gif image/png image/jpg;
                       gzip_vary on;
                       gzip_disable "MSIE [1-6]\.";
                  -
                  +    
                       proxy_ignore_client_abort on;
                       proxy_connect_timeout 100;
                  -   
                  -    client_max_body_size 1000M;
                  +
                  +    client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }
                   

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
api.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.187066
    Duration: 58.33 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -1,13 +1,14 @@
                  +worker_processes  2;
                  +worker_cpu_affinity 0001 0010;
                   
                  -
                  -worker_processes  1;
                  -
                  -error_log  /var/log/nginx-error.log;
                  +error_log  /var/log/nginx/error.log;
                   pid        /usr/local/nginx/nginx.pid;
                   
                   
                   events {
                  -    worker_connections  1024;
                  +    worker_connections  10240;
                  +    use epoll;
                  +    multi_accept on;
                   }
                   
                   
                  @@ -18,8 +19,19 @@
                       log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                                         '$status $body_bytes_sent "$http_referer" '
                                         '"$http_user_agent" "$http_x_forwarded_for"';
                  -
                  -    #access_log  /var/log/nginx-access.log  main;
                  +    log_format logstash_json '{ "@timestamp": "$time_iso8601", '
                  +                         '"@fields": { '
                  +                         '"remote_addr": "$remote_addr", '
                  +                         '"remote_user": "$remote_user", '
                  +                         '"body_bytes_sent": $body_bytes_sent, '
                  +                         '"request_time": $request_time, '
                  +                         '"status": $status, '
                  +                         '"request": "$request", '
                  +                         '"request_uri": "$request_uri", '
                  +                         '"request_method": "$request_method", '
                  +                         '"http_referrer": "$http_referer", '
                  +                         '"http_x_forwarded_for": "$http_x_forwarded_for", '
                  +                         '"http_user_agent": "$http_user_agent" } }';
                   
                       server_names_hash_bucket_size 64;
                   
                  @@ -27,6 +39,7 @@
                       tcp_nopush      on;
                       tcp_nodelay on;
                       keepalive_timeout  30;
                  +    server_tokens off;
                   
                       fastcgi_connect_timeout 300;
                       fastcgi_send_timeout 300;
                  @@ -35,6 +48,9 @@
                       fastcgi_buffers 8 128k;
                       fastcgi_busy_buffers_size 256k;
                       fastcgi_temp_file_write_size 256k;
                  +
                  +    set_real_ip_from   100.109.0.0/16;
                  +    real_ip_header     X-Forwarded-For;
                   
                       gzip on;
                       gzip_min_length  1k;
                  @@ -45,7 +61,11 @@
                       x-httpd-php image/jpeg image/gif image/png image/jpg;
                       gzip_vary on;
                       gzip_disable "MSIE [1-6]\.";
                  +    
                  +    proxy_ignore_client_abort on;
                  +    proxy_connect_timeout 100;
                   
                  +    client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }
                   

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
ytadmin01.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.225994
    Duration: 55.284 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -38,7 +38,7 @@
                       sendfile        on;
                       tcp_nopush      on;
                       tcp_nodelay on;
                  -    keepalive_timeout  100;
                  +    keepalive_timeout  30;
                       server_tokens off;
                   
                       fastcgi_connect_timeout 300;
                  @@ -65,7 +65,7 @@
                       proxy_ignore_client_abort on;
                       proxy_connect_timeout 100;
                   
                  -    client_max_body_size 16M;
                  +    client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }
                   

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
play.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.201698
    Duration: 50.221 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -23,10 +23,11 @@
                                            '"@fields": { '
                                            '"remote_addr": "$remote_addr", '
                                            '"remote_user": "$remote_user", '
                  -                         '"body_bytes_sent": "$body_bytes_sent", '
                  -                         '"request_time": "$request_time", '
                  -                         '"status": "$status", '
                  +                         '"body_bytes_sent": $body_bytes_sent, '
                  +                         '"request_time": $request_time, '
                  +                         '"status": $status, '
                                            '"request": "$request", '
                  +                         '"request_uri": "$request_uri", '
                                            '"request_method": "$request_method", '
                                            '"http_referrer": "$http_referer", '
                                            '"http_x_forwarded_for": "$http_x_forwarded_for", '
                  @@ -48,9 +49,8 @@
                       fastcgi_busy_buffers_size 256k;
                       fastcgi_temp_file_write_size 256k;
                   
                  -
                  -    set_real_ip_from 100.109.0.0/16;
                  -    real_ip_header X-Forwarded-For;
                  +    set_real_ip_from   100.109.0.0/16;
                  +    real_ip_header     X-Forwarded-For;
                   
                       gzip on;
                       gzip_min_length  1k;
                  @@ -62,6 +62,9 @@
                       gzip_vary on;
                       gzip_disable "MSIE [1-6]\.";
                       
                  +    proxy_ignore_client_abort on;
                  +    proxy_connect_timeout 100;
                  +
                       client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
passport.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.209320
    Duration: 61.351 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -23,10 +23,11 @@
                                            '"@fields": { '
                                            '"remote_addr": "$remote_addr", '
                                            '"remote_user": "$remote_user", '
                  -                         '"body_bytes_sent": "$body_bytes_sent", '
                  -                         '"request_time": "$request_time", '
                  -                         '"status": "$status", '
                  +                         '"body_bytes_sent": $body_bytes_sent, '
                  +                         '"request_time": $request_time, '
                  +                         '"status": $status, '
                                            '"request": "$request", '
                  +                         '"request_uri": "$request_uri", '
                                            '"request_method": "$request_method", '
                                            '"http_referrer": "$http_referer", '
                                            '"http_x_forwarded_for": "$http_x_forwarded_for", '
                  @@ -61,6 +62,9 @@
                       gzip_vary on;
                       gzip_disable "MSIE [1-6]\.";
                       
                  +    proxy_ignore_client_abort on;
                  +    proxy_connect_timeout 100;
                  +
                       client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
bbs.wankr.com.cn:
----------
          ID: /usr/local/nginx/conf/nginx.conf
    Function: file.managed
      Result: True
     Comment: File /usr/local/nginx/conf/nginx.conf updated
     Started: 10:31:58.205587
    Duration: 155.063 ms
     Changes:   
              ----------
              diff:
                  ---  
                  +++  
                  @@ -23,9 +23,9 @@
                                            '"@fields": { '
                                            '"remote_addr": "$remote_addr", '
                                            '"remote_user": "$remote_user", '
                  -                         '"body_bytes_sent": "$body_bytes_sent", '
                  -                         '"request_time": "$request_time", '
                  -                         '"status": "$status", '
                  +                         '"body_bytes_sent": $body_bytes_sent, '
                  +                         '"request_time": $request_time, '
                  +                         '"status": $status, '
                                            '"request": "$request", '
                                            '"request_uri": "$request_uri", '
                                            '"request_method": "$request_method", '
                  @@ -62,6 +62,9 @@
                       gzip_vary on;
                       gzip_disable "MSIE [1-6]\.";
                       
                  +    proxy_ignore_client_abort on;
                  +    proxy_connect_timeout 100;
                  +
                       client_max_body_size 12M;
                       include /usr/local/nginx/conf/vhost/*.conf;
                   }

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
